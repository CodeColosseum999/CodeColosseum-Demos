<!DOCTYPE html>                                                                                                                                              
<html lang="en">                                                                                                                                             
<head>                                                                                                                                                       
    <meta charset="UTF-8">                                                                                                                                   
    <meta name="viewport" content="width=device-width, initial-scale=1.0">                                                                                   
    <title>Falling Sand Automata</title>                                                                                                                     
    <style>                                                                                                                                                  
        html, body {                                                                                                                                         
            margin: 0;                                                                                                                                       
            padding: 0;                                                                                                                                      
            background: #000;                                                                                                                                
            overflow: hidden;                                                                                                                                
        }                                                                                                                                                    
        body {                                                                                                                                               
            display: flex;                                                                                                                                   
            justify-content: center;                                                                                                                         
            align-items: center;                                                                                                                             
            min-height: 100vh;                                                                                                                               
        }                                                                                                                                                    
        #container {                                                                                                                                         
            position: relative;                                                                                                                              
            width: 416px;                                                                                                                                    
            height: 416px;                                                                                                                                   
        }                                                                                                                                                    
        canvas {                                                                                                                                             
            display: block;                                                                                                                                  
            image-rendering: pixelated;                                                                                                                      
            image-rendering: crisp-edges;                                                                                                                    
        }                                                                                                                                                    
    </style>                                                                                                                                                 
</head>                                                                                                                                                      
<body>                                                                                                                                                       
    <div id="container">                                                                                                                                     
        <canvas id="canvas"></canvas>                                                                                                                        
    </div>                                                                                                                                                   
                                                                                                                                                             
    <script>                                                                                                                                                 
        (function() {                                                                                                                                        
            'use strict';                                                                                                                                    
                                                                                                                                                             
            // --- URL parameter parsing with sanitization ---                                                                                               
            const urlParams = new URLSearchParams(window.location.search);                                                                                   
            let w = parseInt(urlParams.get('w'));                                                                                                            
            let h = parseInt(urlParams.get('h'));                                                                                                            
            let loopMs = parseInt(urlParams.get('loop'));                                                                                                    
            let speed = parseFloat(urlParams.get('speed'));                                                                                                  
            let t0 = parseInt(urlParams.get('t0'));                                                                                                          
            let phase = parseInt(urlParams.get('phase'));                                                                                                    
                                                                                                                                                             
            // Defaults and clamping                                                                                                                         
            const defaultSize = 416;                                                                                                                         
            w = Number.isFinite(w) && w > 0 ? Math.max(1, w) : defaultSize;                                                                                  
            h = Number.isFinite(h) && h > 0 ? Math.max(1, h) : defaultSize;                                                                                  
            loopMs = Number.isFinite(loopMs) && loopMs > 0 ? Math.max(1000, Math.min(600000, loopMs)) : 10000;                                               
            speed = Number.isFinite(speed) && speed > 0 ? Math.max(0.01, Math.min(100, speed)) : 1;                                                          
            t0 = Number.isFinite(t0) ? t0 : 0;                                                                                                               
            phase = Number.isFinite(phase) ? phase : 0;                                                                                                      
                                                                                                                                                             
            // --- Canvas setup with DPR handling ---                                                                                                        
            const container = document.getElementById('container');                                                                                          
            container.style.width = w + 'px';                                                                                                                
            container.style.height = h + 'px';                                                                                                               
                                                                                                                                                             
            const canvas = document.getElementById('canvas');                                                                                                
            const dpr = window.devicePixelRatio || 1;                                                                                                        
            canvas.style.width = w + 'px';                                                                                                                   
            canvas.style.height = h + 'px';                                                                                                                  
            canvas.width = Math.floor(w * dpr);                                                                                                              
            canvas.height = Math.floor(h * dpr);                                                                                                             
                                                                                                                                                             
            const ctx = canvas.getContext('2d');                                                                                                             
            if (!ctx) {                                                                                                                                      
                throw new Error('Canvas 2D context not available');                                                                                          
            }                                                                                                                                                
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);                                                                                                          
                                                                                                                                                             
            // --- Grid constants ---                                                                                                                        
            const GRID_WIDTH = 100;                                                                                                                          
            const GRID_HEIGHT = 100;                                                                                                                         
            const CELL_SIZE = Math.min(w / GRID_WIDTH, h / GRID_HEIGHT);                                                                                     
            const OFFSET_X = (w - GRID_WIDTH * CELL_SIZE) / 2;                                                                                               
            const OFFSET_Y = (h - GRID_HEIGHT * CELL_SIZE) / 2;                                                                                              
                                                                                                                                                             
            // --- Cell types ---                                                                                                                            
            const EMPTY = 0;                                                                                                                                 
            const SAND = 1;                                                                                                                                  
            const WATER = 2;                                                                                                                                 
            const WOOD = 3;                                                                                                                                  
            const BEDROCK = 4;                                                                                                                               
            const ACID = 5;                                                                                                                                  
                                                                                                                                                             
            const COLORS = [                                                                                                                                 
                '#000000', // EMPTY                                                                                                                          
                '#FFFF00', // SAND bright yellow                                                                                                             
                '#0066FF', // WATER blue                                                                                                                     
                '#8B4513', // WOOD brown                                                                                                                     
                '#444444', // BEDROCK dark gray                                                                                                              
                '#00FF00'  // ACID neon green                                                                                                                
            ];                                                                                                                                               
                                                                                                                                                             
            // --- Seeded PRNG (Mulberry32) ---                                                                                                              
            class SeededRNG {                                                                                                                                
                constructor(seed) {                                                                                                                          
                    this.seed = seed;                                                                                                                        
                }                                                                                                                                            
                next() {                                                                                                                                     
                    let t = this.seed += 0x6D2B79F5;                                                                                                         
                    t = Math.imul(t ^ t >>> 15, t | 1);                                                                                                      
                    t ^= t + Math.imul(t ^ t >>> 7, t | 61);                                                                                                 
                    return ((t ^ t >>> 14) >>> 0) / 4294967296;                                                                                              
                }                                                                                                                                            
                int(min, max) {                                                                                                                              
                    return Math.floor(this.next() * (max - min + 1)) + min;                                                                                  
                }                                                                                                                                            
            }                                                                                                                                                
                                                                                                                                                             
            // --- Simulation state ---                                                                                                                      
            let grid = Array(GRID_WIDTH * GRID_HEIGHT).fill(EMPTY);                                                                                          
            let rng = new SeededRNG(12345);                                                                                                                  
            let lastLoopIndex = -1;                                                                                                                          
            let lastFrameTime = 0;                                                                                                                           
            let acidCounter = 0;                                                                                                                             
                                                                                                                                                             
            // --- Initialize grid with platforms and bedrock ---                                                                                            
            function initGrid() {                                                                                                                            
                grid.fill(EMPTY);                                                                                                                            
                                                                                                                                                             
                // Bedrock at bottom                                                                                                                         
                for (let x = 0; x < GRID_WIDTH; x++) {                                                                                                       
                    grid[(GRID_HEIGHT - 1) * GRID_WIDTH + x] = BEDROCK;                                                                                      
                }                                                                                                                                            
                                                                                                                                                             
                // Three random wood platforms                                                                                                               
                for (let i = 0; i < 3; i++) {                                                                                                                
                    const platformWidth = rng.int(GRID_WIDTH / 4, GRID_WIDTH / 3);                                                                           
                    const platformX = rng.int(0, GRID_WIDTH - platformWidth);                                                                                
                    const platformY = rng.int(GRID_HEIGHT * 0.3, GRID_HEIGHT * 0.7);                                                                         
                    for (let dx = 0; dx < platformWidth; dx++) {                                                                                             
                        const idx = platformY * GRID_WIDTH + (platformX + dx);                                                                               
                        if (idx >= 0 && idx < grid.length) {                                                                                                 
                            grid[idx] = WOOD;                                                                                                                
                        }                                                                                                                                    
                    }                                                                                                                                        
                }                                                                                                                                            
            }                                                                                                                                                
                                                                                                                                                             
            // --- Cell physics ---                                                                                                                          
            function updateCell(x, y, idx) {                                                                                                                 
                const cell = grid[idx];                                                                                                                      
                if (cell === EMPTY || cell === WOOD || cell === BEDROCK) return;                                                                             
                                                                                                                                                             
                const below = idx + GRID_WIDTH;                                                                                                              
                const belowLeft = below - 1;                                                                                                                 
                const belowRight = below + 1;                                                                                                                
                const left = idx - 1;                                                                                                                        
                const right = idx + 1;                                                                                                                       
                                                                                                                                                             
                // SAND: fall down, then diagonal down-left/right                                                                                            
                if (cell === SAND) {                                                                                                                         
                    if (y < GRID_HEIGHT - 1 && grid[below] === EMPTY) {                                                                                      
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[below] = SAND;                                                                                                                  
                    } else if (y < GRID_HEIGHT - 1 && x > 0 && grid[belowLeft] === EMPTY) {                                                                  
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[belowLeft] = SAND;                                                                                                              
                    } else if (y < GRID_HEIGHT - 1 && x < GRID_WIDTH - 1 && grid[belowRight] === EMPTY) {                                                    
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[belowRight] = SAND;                                                                                                             
                    }                                                                                                                                        
                }                                                                                                                                            
                                                                                                                                                             
                // WATER: fall, then spread sideways                                                                                                         
                if (cell === WATER) {                                                                                                                        
                    if (y < GRID_HEIGHT - 1 && grid[below] === EMPTY) {                                                                                      
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[below] = WATER;                                                                                                                 
                    } else {                                                                                                                                 
                        const dir = rng.next() < 0.5 ? -1 : 1;                                                                                               
                        let target = idx + dir;                                                                                                              
                        if (x + dir >= 0 && x + dir < GRID_WIDTH && grid[target] === EMPTY) {                                                                
                            grid[idx] = EMPTY;                                                                                                               
                            grid[target] = WATER;                                                                                                            
                        } else {                                                                                                                             
                            target = idx - dir;                                                                                                              
                            if (x - dir >= 0 && x - dir < GRID_WIDTH && grid[target] === EMPTY) {                                                            
                                grid[idx] = EMPTY;                                                                                                           
                                grid[target] = WATER;                                                                                                        
                            }                                                                                                                                
                        }                                                                                                                                    
                    }                                                                                                                                        
                }                                                                                                                                            
                                                                                                                                                             
                // ACID: fall, then eat adjacent SAND/WOOD                                                                                                   
                if (cell === ACID) {                                                                                                                         
                    if (y < GRID_HEIGHT - 1 && grid[below] === EMPTY) {                                                                                      
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[below] = ACID;                                                                                                                  
                    } else if (y < GRID_HEIGHT - 1 && x > 0 && grid[belowLeft] === EMPTY) {                                                                  
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[belowLeft] = ACID;                                                                                                              
                    } else if (y < GRID_HEIGHT - 1 && x < GRID_WIDTH - 1 && grid[belowRight] === EMPTY) {                                                    
                        grid[idx] = EMPTY;                                                                                                                   
                        grid[belowRight] = ACID;                                                                                                             
                    } else {                                                                                                                                 
                        // Corrode                                                                                                                           
                        const targets = [];                                                                                                                  
                        if (y < GRID_HEIGHT - 1) targets.push(below);                                                                                        
                        if (x > 0) targets.push(left);                                                                                                       
                        if (x < GRID_WIDTH - 1) targets.push(right);                                                                                         
                        if (y > 0) targets.push(idx - GRID_WIDTH);                                                                                           
                                                                                                                                                             
                        for (const t of targets) {                                                                                                           
                            if (grid[t] === SAND || grid[t] === WOOD) {                                                                                      
                                grid[t] = EMPTY;                                                                                                             
                                break;                                                                                                                       
                            }                                                                                                                                
                        }                                                                                                                                    
                        grid[idx] = EMPTY; // Acid consumed                                                                                                  
                    }                                                                                                                                        
                }                                                                                                                                            
            }                                                                                                                                                
                                                                                                                                                             
            // --- Spawners ---                                                                                                                              
            function spawnParticles(progress) {                                                                                                              
                // Fast sand stream from top center                                                                                                          
                const sandX = Math.floor(GRID_WIDTH / 2);                                                                                                    
                const sandY = 0;                                                                                                                             
                const sandIdx = sandY * GRID_WIDTH + sandX;                                                                                                  
                if (grid[sandIdx] === EMPTY) {                                                                                                               
                    grid[sandIdx] = SAND;                                                                                                                    
                }                                                                                                                                            
                                                                                                                                                             
                // Moving water emitter oscillates left-right                                                                                                
                const waterAmplitude = GRID_WIDTH * 0.4;                                                                                                     
                const waterX = Math.floor(GRID_WIDTH / 2 + Math.sin(progress * Math.PI * 4) * waterAmplitude);                                               
                const waterY = 2;                                                                                                                            
                const waterIdx = waterY * GRID_WIDTH + waterX;                                                                                               
                if (waterX >= 0 && waterX < GRID_WIDTH && grid[waterIdx] === EMPTY) {                                                                        
                    grid[waterIdx] = WATER;                                                                                                                  
                }                                                                                                                                            
                                                                                                                                                             
                // Spawn acid drops every ~60 frames (scaled by speed)                                                                                       
                acidCounter++;                                                                                                                               
                const acidInterval = Math.max(1, Math.floor(60 / speed));                                                                                    
                if (acidCounter >= acidInterval) {                                                                                                           
                    acidCounter = 0;                                                                                                                         
                    const acidX = rng.int(0, GRID_WIDTH - 1);                                                                                                
                    const acidY = 0;                                                                                                                         
                    const acidIdx = acidY * GRID_WIDTH + acidX;                                                                                              
                    if (grid[acidIdx] === EMPTY) {                                                                                                           
                        grid[acidIdx] = ACID;                                                                                                                
                    }                                                                                                                                        
                }                                                                                                                                            
            }                                                                                                                                                
                                                                                                                                                             
            // --- Drawing ---                                                                                                                               
            function drawGrid() {                                                                                                                            
                ctx.clearRect(0, 0, w, h);                                                                                                                   
                                                                                                                                                             
                for (let y = 0; y < GRID_HEIGHT; y++) {                                                                                                      
                    for (let x = 0; x < GRID_WIDTH; x++) {                                                                                                   
                        const idx = y * GRID_WIDTH + x;                                                                                                      
                        const cell = grid[idx];                                                                                                              
                        if (cell === EMPTY) continue;                                                                                                        
                                                                                                                                                             
                        const px = OFFSET_X + x * CELL_SIZE;                                                                                                 
                        const py = OFFSET_Y + y * CELL_SIZE;                                                                                                 
                                                                                                                                                             
                        ctx.fillStyle = COLORS[cell];                                                                                                        
                        ctx.fillRect(px, py, CELL_SIZE, CELL_SIZE);                                                                                          
                                                                                                                                                             
                        // Add subtle inner highlight for depth                                                                                              
                        if (cell !== BEDROCK) {                                                                                                              
                            ctx.fillStyle = 'rgba(255,255,255,0.1)';                                                                                         
                            ctx.fillRect(px, py, CELL_SIZE * 0.3, CELL_SIZE * 0.3);                                                                          
                        }                                                                                                                                    
                    }                                                                                                                                        
                }                                                                                                                                            
            }                                                                                                                                                
                                                                                                                                                             
            // --- Main animation loop ---                                                                                                                   
            function animate(timestamp) {                                                                                                                    
                requestAnimationFrame(animate);                                                                                                              
                                                                                                                                                             
                // Wallâ€‘clock progress (unaffected by speed)                                                                                                 
                const nowMs = Date.now();                                                                                                                    
                const loopIndex = Math.floor((nowMs - t0 + phase) / loopMs);                                                                                 
                let progress = ((nowMs - t0 + phase) % loopMs) / loopMs;                                                                                     
                if (!Number.isFinite(progress)) progress = 0;                                                                                                
                                                                                                                                                             
                // Reset simulation on loop boundary                                                                                                         
                if (loopIndex !== lastLoopIndex) {                                                                                                           
                    lastLoopIndex = loopIndex;                                                                                                               
                    rng = new SeededRNG(loopIndex * 1000);                                                                                                   
                    initGrid();                                                                                                                              
                    acidCounter = 0;                                                                                                                         
                }                                                                                                                                            
                                                                                                                                                             
                // Fixed timestep simulation (scaled by speed)                                                                                               
                const dtMs = timestamp - lastFrameTime || 0;                                                                                                 
                lastFrameTime = timestamp;                                                                                                                   
                const dtSec = dtMs / 1000;                                                                                                                   
                const dtSim = dtSec * speed;                                                                                                                 
                                                                                                                                                             
                // Update simulation in multiple substeps for stability                                                                                      
                const substeps = Math.ceil(speed);                                                                                                           
                for (let s = 0; s < substeps; s++) {                                                                                                         
                    // Spawn particles (based on progress, not dtSim)                                                                                        
                    spawnParticles(progress);                                                                                                                
                                                                                                                                                             
                    // Update cells bottom-up for proper stacking                                                                                            
                    for (let y = GRID_HEIGHT - 2; y >= 0; y--) {                                                                                             
                        for (let x = 0; x < GRID_WIDTH; x++) {                                                                                               
                            const idx = y * GRID_WIDTH + x;                                                                                                  
                            updateCell(x, y, idx);                                                                                                           
                        }                                                                                                                                    
                    }                                                                                                                                        
                }                                                                                                                                            
                                                                                                                                                             
                drawGrid();                                                                                                                                  
            }                                                                                                                                                
                                                                                                                                                             
            // --- Start ---                                                                                                                                 
            initGrid();                                                                                                                                      
            requestAnimationFrame(animate);                                                                                                                  
                                                                                                                                                             
            // Ensure container size matches URL params                                                                                                      
            container.style.width = w + 'px';                                                                                                                
            container.style.height = h + 'px';                                                                                                               
        })();                                                                                                                                                
    </script>                                                                                                                                                


<!-- CodeColosseum Watermark v1 -->
<div data-cc-watermark="1" data-cc-id="2026-01-26_falling_sand/deepseek.html" style="position:fixed;bottom:10px;right:10px;opacity:0.55;font-size:12px;line-height:1.2;color:#b0b0b0;z-index:999999;pointer-events:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;mix-blend-mode:screen;user-select:none;">
  Generated for Code Colosseum &bull; 2026-01-26_falling_sand/deepseek.html &bull; d95e36e
</div>
<script data-cc-watermark-script="1">
  console.log("%cSTOP!%c This code was generated for Code Colosseum.", "font-size:20px;color:#ff3b3b;font-weight:800;", "font-size:14px;color:#ddd;font-weight:600;");
</script>

</body>                                                                                                                                                      
</html>